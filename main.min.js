const PRODUCTOS_POR_PAGINA=6,LS_CARRITO_KEY="carrito",CSV_URL=window.SHEET_CSV_URL,PLACEHOLDER_IMAGE=window.PLACEHOLDER_IMAGE||"https://via.placeholder.com/400x400/7ed957/fff?text=Sin+Imagen";let productos=[],carrito=[],paginaActual=1,filtrosActuales={precioMin:null,precioMax:null,categoria:"todos",busqueda:""};const getElement=e=>document.getElementById(e),elementos={galeriaProductos:getElement("galeria-productos"),paginacion:getElement("paginacion"),productoModal:getElement("producto-modal"),modalContenido:getElement("modal-contenido"),listaCarrito:getElement("lista-carrito"),totalCarrito:getElement("total"),contadorCarrito:getElement("contador-carrito"),inputBusqueda:getElement("input-busqueda"),selectCategoria:getElement("filtro-categoria"),precioMinInput:getElement("precio-min"),precioMaxInput:getElement("precio-max"),botonResetearFiltros:getElement("boton-resetear-filtros"),carritoBtnMain:getElement("carrito-btn-main"),carritoPanel:getElement("carrito-panel"),carritoOverlay:document.querySelector(".carrito-overlay"),btnVaciarCarrito:document.querySelector(".boton-vaciar-carrito"),btnFinalizarCompra:document.querySelector(".boton-finalizar-compra"),btnCerrarCarrito:document.querySelector(".cerrar-carrito"),avisoPreCompraModal:getElement("aviso-pre-compra-modal"),btnEntendidoAviso:getElement("btn-entendido-aviso"),btnCancelarAviso:getElement("btn-cancelar-aviso"),productLoader:getElement("product-loader"),hamburguesa:document.querySelector(".hamburguesa"),menu:getElement("menu"),modalDatosEnvio:getElement("modal-datos-envio"),formEnvio:getElement("form-envio")};function mostrarNotificacion(e,t="exito"){const o=document.createElement("div");o.className=`notificacion ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),300)},2500)}function normalizarUrlImagen(e){if(!e)return PLACEHOLDER_IMAGE;const t=e.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)/);if(t)return`https://drive.google.com/uc?export=download&id=${t[1]}`;const o=e.match(/https?:\/\/drive\.google\.com\/open\?id=([^&]+)/);return o?`https://drive.google.com/uc?export=download&id=${o[1]}`:e}function guardarCarrito(){localStorage.setItem("carrito",JSON.stringify(carrito)),actualizarContadorCarrito()}function cargarCarrito(){try{carrito=JSON.parse(localStorage.getItem("carrito"))||[],actualizarContadorCarrito()}catch{carrito=[]}}function vaciarCarrito(){0!==carrito.length?confirm("¿Estás seguro de vaciar el carrito?")&&(carrito=[],guardarCarrito(),renderizarCarrito(),actualizarUI(),mostrarNotificacion("Carrito vaciado","info"),toggleCarrito(!1)):mostrarNotificacion("El carrito ya está vacío","info")}function actualizarContadorCarrito(){const e=carrito.reduce((e,t)=>e+t.cantidad,0);elementos.contadorCarrito&&(elementos.contadorCarrito.textContent=e,elementos.contadorCarrito.classList.toggle("visible",e>0))}function agregarAlCarrito(e,t=1){const o=productos.find(t=>t.id===e);if(!o)return mostrarNotificacion("Producto no encontrado","error");if(t=parseInt(t,10),isNaN(t)||t<1)return mostrarNotificacion("Cantidad inválida","error");const a=carrito.find(t=>t.id===e);a?a.cantidad+=t:carrito.push({id:e,nombre:o.nombre,precio:o.precio,cantidad:t,imagen:o.imagenes[0]||PLACEHOLDER_IMAGE}),guardarCarrito(),actualizarUI(),mostrarNotificacion(`"${o.nombre}" x${t} añadido al carrito`,"exito")}function renderizarCarrito(){if(!elementos.listaCarrito||!elementos.totalCarrito)return;if(0===carrito.length)return elementos.listaCarrito.innerHTML='<p class="carrito-vacio">Tu carrito está vacío</p>',void(elementos.totalCarrito.textContent="Total: $U 0");elementos.listaCarrito.innerHTML=carrito.map(e=>`\n    <li class="carrito-item" data-id="${e.id}">\n      <img src="${e.imagen}" class="carrito-item-img" alt="${e.nombre}" loading="lazy">\n      <div class="carrito-item-info">\n        <span class="carrito-item-nombre">${e.nombre}</span>\n        <span class="carrito-item-precio">$U ${e.precio.toLocaleString("es-UY")} c/u</span>\n        <div class="carrito-item-controls">\n          <button class="disminuir-cantidad" data-id="${e.id}" aria-label="Reducir cantidad">-</button>\n          <span class="carrito-item-cantidad">${e.cantidad}</span>\n          <button class="aumentar-cantidad" data-id="${e.id}" aria-label="Aumentar cantidad">+</button>\n        </div>\n        <span class="carrito-item-subtotal">Subtotal: $U ${(e.precio*e.cantidad).toLocaleString("es-UY")}</span>\n      </div>\n      <button class="eliminar-item" data-id="${e.id}" aria-label="Eliminar producto">\n        <i class="fas fa-trash"></i>\n      </button>\n    </li>\n    `).join("");const e=carrito.reduce((e,t)=>e+t.precio*t.cantidad,0);elementos.totalCarrito.textContent=`Total: $U ${e.toLocaleString("es-UY")}`,document.querySelectorAll(".disminuir-cantidad").forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.dataset.id),o=carrito.find(e=>e.id===t);o&&o.cantidad>1&&(o.cantidad--,guardarCarrito(),renderizarCarrito())})}),document.querySelectorAll(".aumentar-cantidad").forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.dataset.id),o=carrito.find(e=>e.id===t);o&&(o.cantidad++,guardarCarrito(),renderizarCarrito())})}),document.querySelectorAll(".eliminar-item").forEach(e=>{e.addEventListener("click",e=>{const t=parseInt(e.target.dataset.id);carrito=carrito.filter(e=>e.id!==t),guardarCarrito(),renderizarCarrito()})})}function toggleCarrito(e){if(!elementos.carritoPanel||!elementos.carritoOverlay)return;let t;"boolean"==typeof e?(t=e,elementos.carritoPanel.classList.toggle("active",t),elementos.carritoOverlay.classList.toggle("active",t),document.body.classList.toggle("no-scroll",t)):(t=elementos.carritoPanel.classList.toggle("active"),elementos.carritoOverlay.classList.toggle("active",t),document.body.classList.toggle("no-scroll",t)),t&&renderizarCarrito()}async function cargarProductosDesdeSheets(){try{elementos.productLoader&&(elementos.productLoader.style.display="none",elementos.productLoader.hidden=!0),elementos.galeriaProductos&&(elementos.galeriaProductos.innerHTML="");const e=await fetch(CSV_URL,{headers:{"Cache-Control":"no-store"}});if(!e.ok)throw new Error("Error al cargar productos");const t=await e.text();if("undefined"==typeof Papa)throw new Error("Papa Parse no disponible");const{data:o}=Papa.parse(t,{header:!0,skipEmptyLines:!0});if(!o||0===o.length)return void(elementos.galeriaProductos&&(elementos.galeriaProductos.innerHTML='<p class="sin-productos">No hay productos disponibles en este momento.</p>'));productos=o.filter(e=>e.id&&e.nombre&&e.precio).map(e=>({id:parseInt(e.id,10),nombre:e.nombre.trim(),descripcion:e.descripcion||"",precio:parseFloat(e.precio)||0,imagenes:e.foto&&""!==e.foto.trim()?e.foto.split(",").map(e=>normalizarUrlImagen(e.trim())):[PLACEHOLDER_IMAGE],adicionales:e.adicionales?e.adicionales.trim():"",alto:parseFloat(e.alto)||null,ancho:parseFloat(e.ancho)||null,profundidad:parseFloat(e.profundidad)||null,categoria:e.categoria?e.categoria.trim().toLowerCase():"otros",vendido:!!e.vendido&&"true"===e.vendido.trim().toLowerCase(),estado:e.estado?e.estado.trim():""})),actualizarCategorias(),actualizarUI()}catch(e){elementos.galeriaProductos&&(elementos.galeriaProductos.innerHTML='<p class="error-carga">No se pudieron cargar los productos.</p>'),mostrarNotificacion("Error al cargar productos: "+(e.message||e),"error")}}function actualizarCategorias(){if(!elementos.selectCategoria)return;const e=["todos",...new Set(productos.map(e=>e.categoria).filter(Boolean))];elementos.selectCategoria.innerHTML=e.map(e=>`<option value="${e.charAt(0).toUpperCase()+e.slice(1)}">${e.charAt(0).toUpperCase()+e.slice(1)}</option>`).join("")}function filtrarProductos(){return productos.filter(e=>{const{precioMin:t,precioMax:o,categoria:a,busqueda:r}=filtrosActuales,n=r?.toLowerCase()||"";return(null===t||e.precio>=t)&&(null===o||e.precio<=o)&&("todos"===a||e.categoria===a)&&(!n||e.nombre.toLowerCase().includes(n)||e.descripcion.toLowerCase().includes(n))})}function crearCardProducto(e){const t=!0===e.vendido;return`\n    <div class="producto-card" data-id="${e.id}">\n      <img src="${e.imagenes[0]||PLACEHOLDER_IMAGE}" alt="${e.nombre}" class="producto-img" loading="lazy" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">\n      <h3 class="producto-nombre">${e.nombre}</h3>\n      <p class="producto-precio">$U ${e.precio.toLocaleString("es-UY")}</p>\n      ${t?'<p class="producto-stock"><span class="texto-agotado">Agotado</span></p>':""}\n      <div class="card-acciones">\n        <button class="boton-agregar${t?" agotado":""}" data-id="${e.id}" ${t?"disabled":""}>\n          ${t?'<i class="fas fa-times-circle"></i> Agotado':'<i class="fas fa-cart-plus"></i> Agregar'}\n        </button>\n      </div>\n      <button class="boton-detalles" data-id="${e.id}">🛈 Ver Detalle</button>\n    </div>\n  `}function renderizarPaginacion(e){const t=Math.ceil(e/6),o=elementos.paginacion;if(o&&(o.innerHTML="",!(t<=1)))for(let e=1;e<=t;e++){const t=document.createElement("button");t.textContent=e,t.className=e===paginaActual?"pagina-activa":"",t.addEventListener("click",()=>{paginaActual=e,renderizarProductos()}),o.appendChild(t)}}function renderizarProductos(){if(!elementos.galeriaProductos)return;const e=filtrarProductos(),t=6*(paginaActual-1),o=e.slice(t,t+6);0===o.length?elementos.galeriaProductos.innerHTML='<p class="sin-resultados">No se encontraron productos con los filtros aplicados.<button onclick="resetearFiltros()">Mostrar todos</button></p>':elementos.galeriaProductos.innerHTML=o.map(crearCardProducto).join(""),renderizarPaginacion(e.length)}function mostrarModalProducto(e){const t=elementos.productoModal,o=elementos.modalContenido;if(!t||!o)return;const a=!0===e.vendido;let r=0;function n(){t.classList.remove("visible"),setTimeout(()=>{t.style.display="none",document.body.classList.remove("no-scroll")},300)}!function t(){o.innerHTML=`\n      <button class="cerrar-modal" aria-label="Cerrar modal">×</button>\n      <div class="modal-flex">\n        <div class="modal-carrusel">\n          <img src="${e.imagenes[r]||PLACEHOLDER_IMAGE}" class="modal-img" alt="${e.nombre}" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">\n          ${e.imagenes.length>1?`\n          <div class="modal-controls">\n            <button class="modal-prev" aria-label="Imagen anterior" ${0===r?"disabled":""}>\n              <svg width="26" height="26" viewBox="0 0 26 26"><polyline points="17 22 9 13 17 4" fill="none" stroke="#2e7d32" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\n            </button>\n            <button class="modal-next" aria-label="Siguiente imagen" ${r===e.imagenes.length-1?"disabled":""}>\n              <svg width="26" height="26" viewBox="0 0 26 26"><polyline points="9 4 17 13 9 22" fill="none" stroke="#2e7d32" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\n            </button>\n          </div>\n          `:""}\n          <div class="modal-thumbnails">\n            ${e.imagenes.map((e,t)=>`<img src="${e}" class="thumbnail ${t===r?"active":""}" data-index="${t}" alt="Miniatura ${t+1}" onerror="this.onerror=null;this.src='${PLACEHOLDER_IMAGE}';">`).join("")}\n          </div>\n        </div>\n        <div class="modal-info">\n          <h1 class="modal-nombre">${e.nombre}</h1>\n          <p class="modal-precio">$U ${e.precio.toLocaleString("es-UY")}</p>\n          <p class="modal-stock ${a?"agotado":"disponible"}">\n            ${a?"AGOTADO":"DISPONIBLE"}\n          </p>\n          <div class="modal-descripcion">\n            ${e.descripcion||""}\n            <br>\n            ${e.adicionales?`<small><b>Adicionales:</b> ${e.adicionales}</small><br>`:""}\n            ${e.alto||e.ancho||e.profundidad?`<small><b>Medidas:</b> ${e.alto?e.alto+" cm (alto)":""} ${e.ancho?" x "+e.ancho+" cm (ancho)":""} ${e.profundidad?" x "+e.profundidad+" cm (prof.)":""}</small>`:""}\n          </div>\n          <div class="modal-acciones">\n            <input type="number" value="1" min="1" class="cantidad-modal-input" ${a?"disabled":""}>\n            <button class="boton-agregar-modal ${a?"agotado":""}" data-id="${e.id}" ${a?"disabled":""}>\n              ${a?"Agotado":"Agregar al carrito"}\n            </button>\n          </div>\n        </div>\n      </div>\n    `,o.querySelector(".cerrar-modal").onclick=()=>n(),o.querySelector(".boton-agregar-modal")?.addEventListener("click",()=>{const t=+(o.querySelector(".cantidad-modal-input").value||1);agregarAlCarrito(e.id,t),n()}),o.querySelectorAll(".thumbnail").forEach((e,o)=>{e.onclick=()=>{r=o,t()}}),o.querySelector(".modal-prev")?.addEventListener("click",()=>{r>0&&(r--,t())}),o.querySelector(".modal-next")?.addEventListener("click",()=>{r<e.imagenes.length-1&&(r++,t())})}(),t.style.display="flex",setTimeout(()=>{t.classList.add("visible"),document.body.classList.add("no-scroll")},10),t.onclick=e=>{e.target===t&&n()}}function conectarEventoModal(){elementos.galeriaProductos&&(elementos.galeriaProductos.onclick=e=>{const t=e.target.closest(".boton-detalles");if(t){const e=+t.dataset.id,o=productos.find(t=>t.id===e);o&&mostrarModalProducto(o)}const o=e.target.closest(".boton-agregar");if(o){agregarAlCarrito(+o.dataset.id,1)}})}function actualizarUI(){renderizarProductos(),renderizarCarrito(),actualizarContadorCarrito()}function aplicarFiltros(){paginaActual=1,renderizarProductos()}function resetearFiltros(){filtrosActuales={precioMin:null,precioMax:null,categoria:"todos",busqueda:""},elementos.inputBusqueda&&(elementos.inputBusqueda.value=""),elementos.selectCategoria&&(elementos.selectCategoria.value="todos"),elementos.precioMinInput&&(elementos.precioMinInput.value=""),elementos.precioMaxInput&&(elementos.precioMaxInput.value=""),aplicarFiltros()}function inicializarFAQ(){document.querySelectorAll(".faq-toggle").forEach(e=>{e.addEventListener("click",()=>{const t="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",!t);const o=e.nextElementSibling;o&&(o.hidden=t)})})}function inicializarMenuHamburguesa(){const e=document.querySelector(".hamburguesa"),t=document.getElementById("menu");e&&t&&(e.addEventListener("click",function(){const o=t.classList.toggle("active");e.setAttribute("aria-expanded",o),document.body.classList.toggle("no-scroll",o)}),t.querySelectorAll("a").forEach(o=>{o.addEventListener("click",()=>{t.classList.remove("active"),e.setAttribute("aria-expanded",!1),document.body.classList.remove("no-scroll")})}))}function setupContactForm(){const e=document.getElementById("formContacto"),t=document.getElementById("successMessage"),o=document.getElementById("errorMessage");e&&e.addEventListener("submit",a=>{a.preventDefault();const r=document.getElementById("nombre").value,n=document.getElementById("email").value,i=document.getElementById("mensaje").value;emailjs.send("service_89by24g","template_8mn7hdp",{from_name:r,from_email:n,message:i}).then(()=>{t.classList.remove("hidden"),o.classList.add("hidden"),e.reset(),setTimeout(()=>t.classList.add("hidden"),3e3)},e=>{console.error("Error al enviar el mensaje:",e),o.classList.remove("hidden"),t.classList.add("hidden"),setTimeout(()=>o.classList.add("hidden"),3e3)})})}function actualizarResumenPedido(){const e=document.getElementById("resumen-productos"),t=document.getElementById("resumen-total");if(!e||!t)return;if(0===carrito.length)return e.innerHTML='<p class="carrito-vacio">No hay productos en el carrito</p>',void(t.textContent="$U 0");let o="",a=0;carrito.forEach(e=>{const t=e.precio*e.cantidad;a+=t,o+=`\n      <div class="resumen-item">\n        <span>${e.nombre} x${e.cantidad}</span>\n        <span>$U ${t.toLocaleString("es-UY")}</span>\n      </div>\n    `}),o+=`\n    <div class="resumen-item resumen-subtotal">\n      <span>Subtotal:</span>\n      <span>$U ${a.toLocaleString("es-UY")}</span>\n    </div>\n  `,e.innerHTML=o;const r=document.getElementById("select-envio"),n=r?r.value:"retiro";let i=0;"montevideo"===n?i=150:"interior"===n&&(i=300);const s=a+i;t.textContent=`$U ${s.toLocaleString("es-UY")}`}function configurarEnvioWhatsApp(){const e=document.getElementById("form-envio");e&&e.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("input-nombre").value.trim(),o=document.getElementById("input-apellido").value.trim(),a=document.getElementById("input-telefono").value.trim(),r=document.getElementById("input-direccion").value.trim(),n=document.getElementById("select-envio").value,i=document.getElementById("input-notas").value.trim();if(!t||!o||!a||!r&&"retiro"!==n||!n)return void mostrarNotificacion("Por favor completa todos los campos obligatorios","error");let s=carrito.reduce((e,t)=>e+t.precio*t.cantidad,0),c="Retiro en local (Gratis)",l=0;"montevideo"===n?(l=150,c=`Envío Montevideo ($U ${l})`):"interior"===n&&(l=300,c=`Envío Interior ($U ${l})`);const d=s+l;let u="";u=0===carrito.length?"No hay productos en el carrito":carrito.map(e=>`➤ ${e.nombre} x${e.cantidad} - $U ${(e.precio*e.cantidad).toLocaleString("es-UY")}`).join("\n");const m=`¡Hola Patofelting! Quiero hacer un pedido:\n\n*Productos:*\n${u}\n\n*Datos del cliente:*\n👤 ${t} ${o}\n📞 ${a}\n\n*Envío:*\n${c}\n${"retiro"!==n?`📍 Dirección: ${r}\n`:""}\n*Subtotal:* $U ${s.toLocaleString("es-UY")}\n*Costo de envío:* $U ${l.toLocaleString("es-UY")}\n*Total a pagar:* $U ${d.toLocaleString("es-UY")}\n\n${i?`*Notas:*\n${i}`:""}`;window.open(`https://wa.me/59893566283?text=${encodeURIComponent(m)}`,"_blank"),document.getElementById("modal-datos-envio").classList.remove("visible"),setTimeout(()=>{document.getElementById("modal-datos-envio").hidden=!0,carrito=[],guardarCarrito(),actualizarUI(),mostrarNotificacion("Pedido enviado con éxito","exito"),document.getElementById("form-envio").reset()},300)})}function inicializarEventos(){elementos.carritoBtnMain?.addEventListener("click",()=>toggleCarrito(!0)),elementos.carritoOverlay?.addEventListener("click",()=>toggleCarrito(!1)),elementos.btnCerrarCarrito?.addEventListener("click",()=>toggleCarrito(!1)),elementos.btnVaciarCarrito?.addEventListener("click",vaciarCarrito),elementos.btnFinalizarCompra?.addEventListener("click",()=>{0!==carrito.length?elementos.avisoPreCompraModal.style.display="flex":mostrarNotificacion("El carrito está vacío","error")}),elementos.btnEntendidoAviso?.addEventListener("click",function(){elementos.avisoPreCompraModal.style.display="none";const e=document.getElementById("modal-datos-envio");e.hidden=!1,setTimeout(()=>{e.classList.add("visible"),actualizarResumenPedido()},10)}),elementos.btnCancelarAviso?.addEventListener("click",()=>{elementos.avisoPreCompraModal.style.display="none"}),document.getElementById("btn-cerrar-modal-envio")?.addEventListener("click",function(){const e=document.getElementById("modal-datos-envio");e.classList.remove("visible"),setTimeout(()=>{e.hidden=!0},300)}),document.getElementById("select-envio")?.addEventListener("change",function(){const e=document.getElementById("grupo-direccion"),t=document.getElementById("resumen-total");if("retiro"===this.value?(e.style.display="none",document.getElementById("input-direccion").required=!1):(e.style.display="flex",document.getElementById("input-direccion").required=!0),t&&carrito.length>0){const e=carrito.reduce((e,t)=>e+t.precio*t.cantidad,0);let o=0;"montevideo"===this.value?o=150:"interior"===this.value&&(o=300);const a=e+o;t.textContent=`$U ${a.toLocaleString("es-UY")}`}}),elementos.inputBusqueda?.addEventListener("input",e=>{filtrosActuales.busqueda=e.target.value.toLowerCase(),aplicarFiltros()}),elementos.selectCategoria?.addEventListener("change",e=>{filtrosActuales.categoria=e.target.value.toLowerCase(),aplicarFiltros()}),document.querySelectorAll(".aplicar-rango-btn").forEach(e=>{e.addEventListener("click",()=>{filtrosActuales.precioMin=elementos.precioMinInput.value?parseFloat(elementos.precioMinInput.value):null,filtrosActuales.precioMax=elementos.precioMaxInput.value?parseFloat(elementos.precioMaxInput.value):null,aplicarFiltros()})}),elementos.botonResetearFiltros?.addEventListener("click",resetearFiltros),conectarEventoModal(),configurarEnvioWhatsApp()}function init(){emailjs.init("o4IxJz0Zz-LQ8jYKG"),inicializarMenuHamburguesa(),inicializarFAQ(),setupContactForm(),elementos.avisoPreCompraModal&&(elementos.avisoPreCompraModal.style.display="none"),elementos.productoModal&&(elementos.productoModal.style.display="none"),elementos.modalDatosEnvio&&(elementos.modalDatosEnvio.hidden=!0),elementos.productLoader&&(elementos.productLoader.style.display="none",elementos.productLoader.hidden=!0),cargarCarrito(),cargarProductosDesdeSheets(),inicializarEventos()}"loading"!==document.readyState?init():document.addEventListener("DOMContentLoaded",init),window.resetearFiltros=resetearFiltros,window.toggleCarrito=toggleCarrito,window.agregarAlCarrito=agregarAlCarrito,window.mostrarModalProducto=mostrarModalProducto,window.mostrarNotificacion=mostrarNotificacion,window.cargarProductosDesdeSheets=cargarProductosDesdeSheets,window.guardarCarrito=guardarCarrito;